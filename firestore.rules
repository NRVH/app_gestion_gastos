rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isHouseholdMember(householdId) {
      return isAuthenticated() && 
             exists(/databases/$(database)/documents/households/$(householdId)/members/$(request.auth.uid));
    }
    
    // Households collection
    match /households/{householdId} {
      // Permitir leer si estás autenticado (para buscar tus households y por código)
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isHouseholdMember(householdId);
      allow delete: if isHouseholdMember(householdId);
      
      // Members subcollection
      match /members/{memberId} {
        // Permitir leer si estás autenticado (para ver miembros del household)
        allow read: if isAuthenticated();
        // Permitir crear miembro si eres tú mismo
        allow create: if isAuthenticated() && request.auth.uid == memberId;
        allow update: if isAuthenticated() && request.auth.uid == memberId;
        allow delete: if isHouseholdMember(householdId);
      }
      
      // Categories subcollection
      match /categories/{categoryId} {
        allow read, write: if isHouseholdMember(householdId);
      }
      
      // Expenses subcollection
      match /expenses/{expenseId} {
        allow read, write: if isHouseholdMember(householdId);
      }
      
      // Contributions subcollection
      match /contributions/{contributionId} {
        allow read, write: if isHouseholdMember(householdId);
      }
      
      // Month history subcollection
      match /months/{monthId} {
        allow read: if isHouseholdMember(householdId);
        allow write: if isHouseholdMember(householdId);
      }
    }
  }
}
